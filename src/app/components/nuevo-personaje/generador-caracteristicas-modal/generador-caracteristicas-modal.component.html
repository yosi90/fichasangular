<div class="modal-local-backdrop" (click)="cerrarModal()"></div>

<div class="modal-local-panel" (click)="$event.stopPropagation()">
    <mat-card class="h-100">
        <mat-card-header class="modal-header">
            <div class="header-text">
                <mat-card-title>{{tituloModal}}</mat-card-title>
            </div>
            <div class="header-actions">
                <mat-form-field appearance="fill" class="minimo-selector">
                    <mat-label>Tirada mínima</mat-label>
                    <mat-select [value]="estado.minimoSeleccionado" (selectionChange)="onMinimoChange($event.value)">
                        <mat-option *ngFor="let minimo of minimos" [value]="minimo">{{minimo}}</mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="fill" class="tablas-selector">
                    <mat-label>Tablas permitidas</mat-label>
                    <mat-select [value]="estado.tablasPermitidas" (selectionChange)="onTablasPermitidasChange($event.value)">
                        <mat-option *ngFor="let cantidad of tablasPermitidasOpciones" [value]="cantidad">{{cantidad}}</mat-option>
                    </mat-select>
                </mat-form-field>
                <button mat-icon-button (click)="cerrarModal()" aria-label="Cerrar modal">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </mat-card-header>

        <mat-card-content class="modal-content">
            <section class="bloque">
                <h4 class="m-0">Tablas de tiradas disponibles</h4>
                <div class="tablas-scroll">
                    <div class="tablas-grid">
                        <div class="tabla-card" *ngFor="let tabla of tablasVisibles"
                            [class.tabla-seleccionada]="isTablaSeleccionada(tabla.numero)"
                            (click)="seleccionarTabla(tabla.numero)">
                            <h4>Tabla {{tabla.numero}}</h4>
                            <div class="valores">
                                <span class="valor" *ngFor="let valor of tabla.valores">{{valor}}</span>
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <section class="bloque" *ngIf="estado.tablaSeleccionada !== null">
                <h4 class="m-0">Pool disponible</h4>
                <div class="pool-grid">
                    <button
                        mat-stroked-button
                        class="pool-item"
                        *ngFor="let _ of estado.poolDisponible; let i = index"
                        [draggable]="estado.poolDisponible[i] >= 0"
                        [class.pool-item-usado]="estado.poolDisponible[i] < 0"
                        (dragstart)="iniciarArrastre(i, $event)"
                        (click)="onClickPoolItem(i)">
                        {{getPoolValor(i)}}
                    </button>
                </div>
            </section>

            <section class="bloque">
                <h4 class="m-0">Asignación</h4>
                <div class="atributos-grid">
                    <div class="atributo-item" *ngFor="let item of caracteristicas">
                        <div class="atributo-label">{{item.label}}</div>
                        <div class="atributo-mod">Mod. racial: {{formatMod(getModRacial(item.key))}}</div>
                        <div
                            class="atributo-drop"
                            [class.atributo-drop-bloqueado]="caracteristicaBloqueada(item.key)"
                            [class.atributo-drop-completo]="estado.asignaciones[item.key] !== null"
                            [class.atributo-drop-clickable]="caracteristicaConValor(item.key)"
                            (dragover)="permitirSoltar($event)"
                            (drop)="soltarEnCaracteristica(item.key, $event)"
                            (click)="onClickCaracteristica(item.key)">
                            {{getValorAsignado(item.key)}}
                        </div>
                        <div class="atributo-preview" *ngIf="getPreviewCaracteristica(item.key) as preview">
                            <span>Resultado: {{preview.valorFinal}}</span>
                            <span>Mod: {{formatMod(preview.modificador)}}</span>
                        </div>
                    </div>
                </div>
            </section>
        </mat-card-content>

        <mat-card-actions class="d-flex justify-content-end gap-2 p-3">
            <button mat-raised-button color="accent" (click)="cerrarModal()">Cerrar</button>
            <button mat-raised-button color="primary" [disabled]="!puedeFinalizar" (click)="finalizarAsignacion()">Finalizar</button>
        </mat-card-actions>
    </mat-card>
</div>
