<div class="nuevo-personaje-shell">
    <mat-tab-group
        #nuevoPersonajeTabControl
        mat-stretch-tabs="false"
        mat-align-tabs="start"
        [selectedIndex]="selectedInternalTabIndex"
        (selectedIndexChange)="onInternalTabIndexChange($event)">
        <mat-tab label="raza">
            <ng-template mat-tab-label="">
                <mat-icon class="me-2">settings_accessibility</mat-icon>
                Raza
            </ng-template>
            <app-listado-razas
                [homebrewSeleccionado]="homebrewForzado"
                [homebrewBloqueado]="homebrewForzado"
                (razaDetalles)="verDetallesRaza($event)"
                (razaSeleccionada)="seleccionarRaza($event)">
            </app-listado-razas>
        </mat-tab>
        <mat-tab label="datos" [disabled]="!razaElegida">
            <ng-template mat-tab-label="">
                <mat-icon class="me-2">badge</mat-icon>
                Básicos
            </ng-template>
            <div class="container-fluid h-100 py-2 basicos-view" *ngIf="razaSeleccionada as raza; else sinRazaSeleccionada">
                <div class="row basicos-content">
                    <div class="col-md-4 col-12 p-2 basicos-col">
                        <div class="sombra-caja-sm rounded p-2 my-2 seccion-form">
                            <mat-chip class="h-auto w-100 sombra-caja-sm py-2 m-1 mb-3">
                                Nombre del personaje
                                <mat-icon class="ms-2">person</mat-icon>
                            </mat-chip>
                            <mat-form-field appearance="fill" class="w-100 nombre-hero__field">
                                <mat-label>Nombre</mat-label>
                                <input matInput [(ngModel)]="Personaje.Nombre" placeholder="Nombre del personaje">
                            </mat-form-field>
                        </div>
                        <div class="sombra-caja-sm rounded p-2 my-2 seccion-form">
                            <mat-chip class="h-auto w-100 sombra-caja-sm py-2 m-1 mb-3">
                                Identidad
                                <mat-icon class="ms-2">assignment_ind</mat-icon>
                            </mat-chip>
                            <div class="field-grid">
                                <mat-form-field appearance="fill" class="full-span">
                                    <mat-label>Genero</mat-label>
                                    <mat-select [(value)]="Personaje.Genero">
                                        <mat-option *ngFor="let genero of generos" [value]="genero">{{genero}}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <div class="alineamiento-bloque full-span">
                                    <mat-form-field appearance="fill" class="w-100 m-0">
                                        <mat-label>Alineamiento</mat-label>
                                        <mat-select [(ngModel)]="Personaje.Alineamiento" [compareWith]="compararAlineamiento" (selectionChange)="recalcularOficialidad()">
                                            <mat-option *ngFor="let alineamiento of alineamientos" [value]="alineamiento">{{alineamiento}}</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                    <div class="alineamiento-preferencias">
                                        <p class="m-0"><strong>Base de la raza:</strong> {{alineamientoBaseRaza}}</p>
                                        <p class="m-0"><strong>Preferencia de la raza (ley/normas):</strong> {{preferenciaLeyRaza}}</p>
                                        <p class="m-0"><strong>Preferencia de la raza (moral/trato):</strong> {{preferenciaMoralRaza}}</p>
                                    </div>
                                </div>
                                <div class="deidad-bloque full-span">
                                    <mat-form-field appearance="fill" class="w-100 m-0">
                                        <mat-label>Deidad</mat-label>
                                        <input matInput [(ngModel)]="Personaje.Deidad" (ngModelChange)="recalcularOficialidad()" [matAutocomplete]="deidadAuto" placeholder="No tener deidad">
                                        <mat-autocomplete #deidadAuto="matAutocomplete">
                                            <mat-option *ngFor="let deidad of deidadesFiltradas" [value]="deidad">{{deidad}}</mat-option>
                                        </mat-autocomplete>
                                    </mat-form-field>
                                    <div class="deidad-contexto" *ngIf="mostrarPanelDeidad">
                                        <p class="m-0"><strong>Deidad:</strong> {{deidadSeleccionadaTexto}}</p>
                                        <p class="m-0"><strong>Alineamiento de referencia:</strong> {{deidadAlineamientoInfo}}</p>
                                        <p class="m-0"><strong>Estado en catalogo:</strong> {{deidadOficialidadInfo}}</p>
                                        <p class="m-0">{{deidadDescripcionInfo}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-12 p-2 basicos-col">
                        <div class="sombra-caja-sm rounded p-2 my-2 seccion-form">
                            <mat-chip class="h-auto w-100 sombra-caja-sm py-2 m-1 mb-3">
                                Campaña
                                <mat-icon class="ms-2">campaign</mat-icon>
                            </mat-chip>
                            <div class="field-grid">
                                <mat-form-field appearance="fill" class="full-span">
                                    <mat-label>Campana</mat-label>
                                    <mat-select [(value)]="Personaje.Campana" (selectionChange)="actualizarTramas()">
                                        <mat-option value="Sin campaña">Sin campaña</mat-option>
                                        <mat-option *ngFor="let campana of Campanas" [value]="campana.Nombre">{{campana.Nombre}}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="fill">
                                    <mat-label>Trama</mat-label>
                                    <mat-select [(value)]="Personaje.Trama" [disabled]="!campanaTieneTramas" (selectionChange)="actualizarSubtramas()">
                                        <mat-option value="Trama base" *ngIf="Personaje.Campana === 'Sin campaña'">Trama base</mat-option>
                                        <mat-option *ngFor="let trama of Tramas" [value]="trama.Nombre">{{trama.Nombre}}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="fill">
                                    <mat-label>Subtrama</mat-label>
                                    <mat-select [(value)]="Personaje.Subtrama" [disabled]="!tramaTieneSubtramas">
                                        <mat-option value="Subtrama base" *ngIf="!tramaTieneSubtramas">Subtrama base</mat-option>
                                        <mat-option *ngFor="let subtrama of Subtramas" [value]="subtrama.Nombre">{{subtrama.Nombre}}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="sombra-caja-sm rounded p-2 my-2 seccion-form">
                            <mat-chip class="h-auto w-100 sombra-caja-sm py-2 m-1 mb-3">
                                Cuerpo
                                <mat-icon class="ms-2">straighten</mat-icon>
                            </mat-chip>
                            <div class="field-grid">
                                <div class="edad-bloque full-span">
                                    <mat-form-field appearance="fill" class="w-100 m-0">
                                        <mat-label>Edad</mat-label>
                                        <input matInput type="number" min="0" [(ngModel)]="Personaje.Edad" (ngModelChange)="recalcularOficialidad()">
                                    </mat-form-field>
                                    <div class="edad-contexto">
                                        <p class="m-0"><strong>Etapas tipicas:</strong> {{rangoEdadTexto}}</p>
                                        <p class="m-0"><strong>Etapa actual:</strong> {{etapaEdadActual}}</p>
                                        <p class="m-0">{{edadMensajeContextual}}</p>
                                    </div>
                                </div>
                                <mat-chip class="bad mb-2 chip-alerta" *ngIf="edadFueraRango">
                                    La edad elegida sale del rango tipico de la raza.
                                </mat-chip>
                                <mat-form-field appearance="fill">
                                    <mat-label>Peso (kg)</mat-label>
                                    <input matInput type="number" min="0" step="0.1" [(ngModel)]="Personaje.Peso" (ngModelChange)="recalcularOficialidad()">
                                    <mat-hint>Recomendado {{raza.Peso_rango_inf}} - {{raza.Peso_rango_sup}}</mat-hint>
                                </mat-form-field>
                                <mat-form-field appearance="fill">
                                    <mat-label>Altura (m)</mat-label>
                                    <input matInput type="number" min="0" step="0.01" [(ngModel)]="Personaje.Altura" (ngModelChange)="recalcularOficialidad()">
                                    <mat-hint>Recomendado {{raza.Altura_rango_inf}} - {{raza.Altura_rango_sup}}</mat-hint>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-12 p-2 basicos-col">
                        <div class="sombra-caja-sm rounded p-2 my-2">
                            <mat-chip class="w-100 sombra-caja-sm mb-2">Contexto</mat-chip>
                            <mat-form-field appearance="fill" class="w-100">
                                <mat-label>Trasfondo</mat-label>
                                <textarea matInput rows="7" [(ngModel)]="Personaje.Contexto" [placeholder]="placeholderContexto"></textarea>
                            </mat-form-field>
                        </div>
                        <div class="sombra-caja-sm rounded p-2 my-2">
                            <mat-chip class="w-100 sombra-caja-sm mb-2">Personalidad</mat-chip>
                            <mat-form-field appearance="fill" class="w-100">
                                <mat-label>Rasgos de personalidad</mat-label>
                                <textarea matInput rows="7" [(ngModel)]="Personaje.Personalidad" [placeholder]="placeholderPersonalidad"></textarea>
                            </mat-form-field>
                        </div>
                    </div>
                </div>
                <div class="basicos-action-fixed">
                    <button mat-raised-button color="primary" [disabled]="!puedeContinuarBasicos" (click)="continuarDesdeBasicos()">
                        Siguiente
                        <mat-icon>arrow_forward</mat-icon>
                    </button>
                </div>
            </div>
            <ng-template #sinRazaSeleccionada>
                <div class="d-flex justify-content-center align-items-center h-100 w-100 px-3">
                    <mat-chip class="h-auto warm p-3">
                        Primero selecciona una raza para continuar con los datos base.
                    </mat-chip>
                </div>
            </ng-template>
        </mat-tab>
        <mat-tab label="plantillas" [disabled]="!caracteristicasGeneradas">
            <ng-template mat-tab-label="">
                <mat-icon class="me-2">view_in_ar</mat-icon>
                Plantillas
            </ng-template>
            <div class="container-fluid py-3 h-100">
                <mat-card class="h-100 sombra-caja-sm plantillas-skeleton" *ngIf="mostrarBloquePlantillas; else bloqueoPlantillas">
                    <mat-card-content class="px-3 py-2 d-flex flex-column gap-2 plantillas-layout">
                        <div class="plantillas-filtros">
                            <mat-form-field appearance="fill" class="w-100">
                                <mat-label>Buscar plantilla</mat-label>
                                <input matInput [ngModel]="filtroPlantillasTexto" (ngModelChange)="onFiltroPlantillasTextoChange($event)" placeholder="Nombre de plantilla">
                            </mat-form-field>
                            <mat-form-field appearance="fill" class="w-100">
                                <mat-label>Manual</mat-label>
                                <mat-select [value]="filtroPlantillasManual" (selectionChange)="onFiltroPlantillasManualChange($event.value)">
                                    <mat-option *ngFor="let manual of manualesPlantillas" [value]="manual">{{manual}}</mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-chip-option color="warn" class="filtro-chip" [selected]="incluirHomebrewPlantillasEfectivo"
                                [disabled]="homebrewForzado"
                                (click)="alternarHomebrewPlantillas()">
                                {{incluirHomebrewPlantillasEfectivo ? 'Homebrew incluido' : 'Incluir homebrew'}}
                            </mat-chip-option>
                        </div>

                        <div class="row g-2 plantillas-zonas">
                            <div class="col-md-7 col-12">
                                <div class="sombra-caja-sm rounded p-2 h-100">
                                    <mat-chip class="w-100 sombra-caja-sm mb-2">Plantillas elegibles</mat-chip>
                                    <div *ngIf="cargandoPlantillas" class="text-center p-3">
                                        <mat-chip>Cargando plantillas...</mat-chip>
                                    </div>
                                    <div *ngIf="!cargandoPlantillas && plantillasElegibles.length < 1" class="text-center p-3">
                                        <mat-chip>No hay plantillas elegibles con los filtros actuales</mat-chip>
                                    </div>
                                    <mat-chip-set class="m-1" *ngIf="plantillasElegibles.length > 0">
                                        <mat-chip *ngFor="let plantilla of plantillasElegibles" class="h-auto chip-clic sombra3d-sm"
                                            (click)="seleccionarPlantilla(plantilla)">
                                            {{plantilla.Nombre}}
                                            <mat-chip class="m-1" *ngIf="plantilla.Ajuste_nivel > 0">Ajuste +{{plantilla.Ajuste_nivel}}</mat-chip>
                                            <mat-chip class="m-1" *ngIf="plantilla.Nacimiento">Heredada</mat-chip>
                                            <mat-chip class="m-1" *ngIf="!plantilla.Oficial">Homebrew</mat-chip>
                                            <button mat-icon-button class="plantilla-detalle-btn"
                                                (click)="verDetallesPlantilla(plantilla); $event.stopPropagation()"
                                                aria-label="Ver detalle de plantilla" matTooltip="Ver detalles">
                                                <mat-icon>open_in_new</mat-icon>
                                            </button>
                                        </mat-chip>
                                    </mat-chip-set>

                                    <mat-chip class="w-100 sombra-caja-sm mt-3 mb-2" *ngIf="plantillasBloqueadasUnknown.length > 0">
                                        Bloqueadas por formato de prerrequisito no soportado
                                    </mat-chip>
                                    <mat-chip-set class="m-1" *ngIf="plantillasBloqueadasUnknown.length > 0">
                                        <mat-chip *ngFor="let item of plantillasBloqueadasUnknown" class="h-auto sombra3d-sm chip-bloqueada"
                                            [matTooltip]="getTooltipBloqueoUnknown(item)" matTooltipClass="tt-accent tt-multiline">
                                            {{item.plantilla.Nombre}}
                                            <mat-chip class="m-1">Bloqueada</mat-chip>
                                            <button mat-icon-button class="plantilla-detalle-btn"
                                                (click)="verDetallesPlantilla(item.plantilla); $event.stopPropagation()"
                                                aria-label="Ver detalle de plantilla" matTooltip="Ver detalles">
                                                <mat-icon>open_in_new</mat-icon>
                                            </button>
                                        </mat-chip>
                                    </mat-chip-set>

                                    <mat-chip class="w-100 sombra-caja-sm mt-3 mb-2"
                                        *ngIf="mostrarDiagnosticoPlantillas && plantillasBloqueadasFailed.length > 0">
                                        Diagnostico temporal: bloqueadas por prerrequisitos no cumplidos
                                    </mat-chip>
                                    <mat-chip-set class="m-1" *ngIf="mostrarDiagnosticoPlantillas && plantillasBloqueadasFailed.length > 0">
                                        <mat-chip *ngFor="let item of plantillasBloqueadasFailed" class="h-auto sombra3d-sm chip-bloqueada"
                                            [matTooltip]="getTooltipBloqueoUnknown(item)" matTooltipClass="tt-accent tt-multiline">
                                            {{item.plantilla.Nombre}}
                                            <mat-chip class="m-1">No cumple</mat-chip>
                                            <button mat-icon-button class="plantilla-detalle-btn"
                                                (click)="verDetallesPlantilla(item.plantilla); $event.stopPropagation()"
                                                aria-label="Ver detalle de plantilla" matTooltip="Ver detalles">
                                                <mat-icon>open_in_new</mat-icon>
                                            </button>
                                        </mat-chip>
                                    </mat-chip-set>
                                </div>
                            </div>

                            <div class="col-md-5 col-12">
                                <div class="sombra-caja-sm rounded p-2 h-100 d-flex flex-column gap-2">
                                    <div class="plantillas-resumen-linea">
                                        <mat-chip class="sombra-caja-sm resumen-chip-seleccion">Seleccion actual</mat-chip>
                                        <mat-chip class="resumen-chip-tipo warm" *ngIf="mostrarTipoCriaturaResultante">
                                            Tipo resultante: {{tipoCriaturaSimuladaTexto}}
                                        </mat-chip>
                                    </div>
                                    <mat-chip class="w-100" *ngIf="plantillasSeleccionadas.length < 1">Sin plantillas seleccionadas</mat-chip>
                                    <mat-chip-set class="m-1" *ngIf="plantillasSeleccionadas.length > 0">
                                        <mat-chip *ngFor="let plantilla of plantillasSeleccionadas" class="h-auto sombra3d-sm chip-seleccionada">
                                            {{plantilla.Nombre}}
                                            <button mat-icon-button class="plantilla-detalle-btn"
                                                (click)="verDetallesPlantilla(plantilla); $event.stopPropagation()"
                                                aria-label="Ver detalle de plantilla" matTooltip="Ver detalles">
                                                <mat-icon>open_in_new</mat-icon>
                                            </button>
                                            <button mat-icon-button class="ms-1" (click)="quitarPlantillaSeleccion(plantilla.Id)" aria-label="Quitar plantilla">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </mat-chip>
                                    </mat-chip-set>
                                    <div class="d-flex justify-content-end">
                                        <button mat-stroked-button color="warn" (click)="limpiarSeleccionPlantillas()" [disabled]="plantillasSeleccionadas.length < 1">
                                            Limpiar seleccion
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </mat-card-content>
                    <mat-card-actions class="d-flex justify-content-end p-3">
                        <button mat-raised-button color="primary" (click)="continuarDesdePlantillas()">
                            Siguiente
                            <mat-icon>arrow_forward</mat-icon>
                        </button>
                    </mat-card-actions>
                </mat-card>
                <ng-template #bloqueoPlantillas>
                    <div class="d-flex justify-content-center align-items-center h-100 w-100 px-3">
                        <mat-chip class="h-auto warm p-3">Genera caracteristicas para desbloquear esta pestana.</mat-chip>
                    </div>
                </ng-template>
            </div>
        </mat-tab>
        <mat-tab label="ventajas" [disabled]="!caracteristicasGeneradas">
            <ng-template mat-tab-label="">
                <mat-icon class="me-2">balance</mat-icon>
                Ventajas y desventajas
            </ng-template>
            <div class="container-fluid py-3 h-100 ventajas-view">
                <mat-card class="h-100 sombra-caja-sm p-2 d-flex flex-column gap-2">
                    <mat-chip class="w-100 h-auto warm homebrew-banner">
                        <span class="homebrew-banner-text">Sistema homebrew: solo con permiso del máster. Tu personaje no será oficial.</span>
                        <button type="button" class="homebrew-help-chip" (click)="abrirInfoVentajasHomebrew($event)"
                            matTooltip="Más info sobre este sistema" aria-label="Información sobre ventajas y desventajas homebrew">
                            <mat-icon>help_outline</mat-icon>
                        </button>
                    </mat-chip>

                    <div class="ventajas-resumen-barra">
                        <mat-chip>Puntos disponibles: {{flujoVentajas.puntosDisponibles}}</mat-chip>
                        <mat-chip>Puntos gastados: {{flujoVentajas.puntosGastados}}</mat-chip>
                        <mat-chip [ngClass]="flujoVentajas.puntosRestantes < 0 ? 'bad' : ''">
                            Restantes: {{flujoVentajas.puntosRestantes}}
                        </mat-chip>
                        <mat-chip [ngClass]="ventajasSeleccionadasCount >= 3 ? 'bad' : ''">
                            Ventajas: {{ventajasSeleccionadasCount}}/3
                        </mat-chip>
                        <mat-chip-option color="warn" [selected]="homebrewVentajasSeleccionado"
                            [disabled]="homebrewVentajasBloqueado" (click)="alternarHomebrewVentajas()">
                            {{textoChipHomebrewVentajas}}
                        </mat-chip-option>
                        <mat-chip class="bad chip-deficit" *ngIf="flujoVentajas.hayDeficit">
                            Tienes déficit de puntos de ventaja. Añade desventajas o quita ventajas para continuar.
                        </mat-chip>
                    </div>

                    <div class="row g-2 ventajas-listados">
                        <div class="col-lg-6 col-12">
                            <div class="sombra-caja-sm rounded p-2 h-100">
                                <mat-chip class="w-100 sombra-caja-sm mb-2">Desventajas</mat-chip>
                                <div *ngIf="cargandoVentajas" class="text-center p-2">
                                    <mat-chip>Cargando desventajas...</mat-chip>
                                </div>
                                <div class="tabla-scroll" *ngIf="!cargandoVentajas">
                                    <table class="tabla-ventajas">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>Nombre</th>
                                                <th>Coste</th>
                                                <th>Descripción</th>
                                                <th>Materia</th>
                                                <th>Mejora</th>
                                                <th>Disipable</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let item of desventajasVisibles">
                                                <td>
                                                    <mat-checkbox [checked]="isDesventajaSeleccionada(item.Id)"
                                                        (change)="toggleDesventajaSeleccion(item)">
                                                    </mat-checkbox>
                                                </td>
                                                <td>{{item.Nombre}}</td>
                                                <td>{{item.Coste > 0 ? '+' : ''}}{{item.Coste}}</td>
                                                <td>{{item.Descripcion}}</td>
                                                <td>{{getMateriaVisible(item)}}</td>
                                                <td>{{getMejoraVisible(item)}}</td>
                                                <td>{{getDisipableVisible(item)}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-12">
                            <div class="sombra-caja-sm rounded p-2 h-100">
                                <mat-chip class="w-100 sombra-caja-sm mb-2">Ventajas</mat-chip>
                                <div *ngIf="cargandoVentajas" class="text-center p-2">
                                    <mat-chip>Cargando ventajas...</mat-chip>
                                </div>
                                <div class="tabla-scroll" *ngIf="!cargandoVentajas">
                                    <table class="tabla-ventajas">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>Nombre</th>
                                                <th>Coste</th>
                                                <th>Descripción</th>
                                                <th>Materia</th>
                                                <th>Mejora</th>
                                                <th>Disipable</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let item of ventajasVisibles" [ngClass]="tieneIdiomaPendiente(item) ? 'fila-pendiente' : ''">
                                                <td>
                                                    <mat-checkbox [checked]="isVentajaSeleccionada(item.Id)"
                                                        (change)="toggleVentajaSeleccion(item)">
                                                    </mat-checkbox>
                                                </td>
                                                <td>
                                                    {{item.Nombre}}
                                                    <span class="ms-1 texto-pendiente" *ngIf="tieneIdiomaPendiente(item)">Selecciona idioma</span>
                                                </td>
                                                <td>{{item.Coste > 0 ? '+' : ''}}{{item.Coste}}</td>
                                                <td>{{item.Descripcion}}</td>
                                                <td>{{getMateriaVisible(item)}}</td>
                                                <td>{{getMejoraVisible(item)}}</td>
                                                <td>{{getDisipableVisible(item)}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end p-2">
                        <button mat-raised-button color="primary" [disabled]="!puedeContinuarVentajas" (click)="continuarDesdeVentajas()">
                            Siguiente
                            <mat-icon>arrow_forward</mat-icon>
                        </button>
                    </div>
                </mat-card>
            </div>
        </mat-tab>
    </mat-tab-group>

    <ng-container *ngIf="ventanaDetalleAbierta && !modalCaracteristicasAbierto">
        <app-ventana-detalle-flotante
            [titulo]="tituloVentanaDetalle"
            [bloqueadaPorOverlay]="modalCaracteristicasAbierto"
            (cerrarSolicitado)="onSolicitarCerrarVentanaDetalle()">
            <app-detalles-personaje
                [pj]="Personaje"
                [mostrarBotonGenerarPdf]="false"
                (razaDetalles)="verDetallesRazaDesdeFicha($event)"
                (plantillaDetalles)="verDetallesPlantillaDesdeFicha($event)"
                (rasgoDetalles)="verDetallesRasgo($event)"
                (racialDetallesPorNombre)="verDetallesRacialDesdeReferencia($event)">
            </app-detalles-personaje>
        </app-ventana-detalle-flotante>
    </ng-container>

    <ng-container *ngIf="modalCaracteristicasAbierto && razaSeleccionada as razaActual">
        <app-generador-caracteristicas-modal
            [raza]="razaActual"
            [caracteristicasPerdidas]="Personaje.Caracteristicas_perdidas ?? null"
            [pierdeConstitucion]="razaActual.Tipo_criatura.Pierde_constitucion"
            (cerrar)="cerrarModalCaracteristicas()"
            (finalizar)="finalizarGeneracionCaracteristicas($event)">
        </app-generador-caracteristicas-modal>
    </ng-container>

    <ng-container *ngIf="modalSelectorIdiomaAbierto">
        <app-selector-idioma-modal
            [idiomas]="catalogoIdiomas"
            [idiomasYaSeleccionados]="idiomasSeleccionadosParaSelector"
            [personajeOficial]="Personaje.Oficial"
            [incluirHomebrew]="incluirHomebrewIdiomasEfectivo"
            [titulo]="selectorIdiomaTitulo"
            [cantidadObjetivo]="selectorIdiomaCantidadObjetivo"
            [cantidadSeleccionada]="selectorIdiomaCantidadSeleccionada"
            [bloquearCierreHastaCompletar]="selectorIdiomaBloquearCierre"
            (incluirHomebrewChange)="onCambioHomebrewModalIdiomas($event)"
            (cerrar)="onCerrarModalIdioma()"
            (confirmar)="onConfirmarIdiomaVentaja($event)">
        </app-selector-idioma-modal>
    </ng-container>
</div>
